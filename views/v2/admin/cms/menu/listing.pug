extends ../../layouts/master.pug

block csslib
	link(href='/admin/assets/plugins/custom/datatables/datatables.bundle.css' rel='stylesheet' type='text/css')
	link(href='/admin/assets/plugins/custom/jstree/jstree.bundle.css' rel='stylesheet' type='text/css')

block jslib
	// begin::Vendors Javascript(used by this page)
	script(src='/admin/assets/plugins/custom/datatables/datatables.bundle.js')
	// end::Vendors Javascript
	// begin::Custom Javascript(used by this page)
	script(src='https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js')
	script(src='/admin/assets/js/custom/apps/ecommerce/catalog/products.js')
	script(src='/admin/assets/js/widgets.bundle.js')
	script(src='/admin/assets/js/custom/widgets.js')
	script(src='/admin/assets/js/custom/apps/chat/chat.js')
	script(src='/admin/assets/js/custom/utilities/modals/upgrade-plan.js')
	script(src='/admin/assets/js/custom/utilities/modals/create-app.js')
	script(src='/admin/assets/js/custom/utilities/modals/users-search.js')
	script(src='/admin/assets/plugins/custom/jstree/jstree.bundle.js')

	// Form Submission Script
	script(src='/common/js/form-data-json.min.js')
	script(src='/common/js/es-form.js')

block customScript
	script.
		$(".jstree_dragdrop").jstree({
			"core" : {
				"themes" : {
					"responsive": false
				},
				// so that create works
				"check_callback" : true,
			},
			"types" : {
				"default" : {
					"icon" : "fa fa-folder text-success",
					"max_children":10,
					"max_depth":2,
				},
				"file" : {
					"icon" : "fa fa-file  text-success"
				}
			},
			"state" : { "key" : "demo2" },
			"plugins" : [ "dnd", "state", "types" ]
		});

		function saveMenuSorting(treeData,name) {
			const data = {
				'menu' : treeData,
				name
			}
			axios.post('/admin/cms/menu/save', data)
			.then(async function (res) {
				location.reload()
			})
			.catch(function (error) {
				console.log(error);
			});
		}

		function deleteMenuItem(item) {
			const id = item.getAttribute('id')
			const nav_position = item.getAttribute('nav_position')
			const level = item.getAttribute('level')
			const obj = {
				id,
				nav_position,
				level
			}
			Swal.fire({
				text: 'Are you sure you want to delete ?',
				icon: 'warning',
				showCancelButton: !0,
				buttonsStyling: !1,
				confirmButtonText: 'Yes, delete!',
				cancelButtonText: 'No, cancel',
				customClass: {
					confirmButton: 'btn fw-bold btn-danger',
					cancelButton: 'btn fw-bold btn-active-light-primary',
				},
			}).then((e) => {
				if(e.value){
					axios
					.post('/admin/cms/menu/delete', obj)
					.then((res) => {
						let data = res.data
						Swal.fire({
							text: data.message || 'You have deleted  !.',
							icon: 'success',
							buttonsStyling: !1,
							confirmButtonText: 'Ok',
							customClass: {
								confirmButton: 'btn fw-bold btn-primary',
							},
						}).then(() => {
							location.reload()
						})
					}).catch((error) => {
						let data = error?.response?.data
						Swal.fire({
							text: data.error||'Something went wrong !.',
							icon: 'warning',
							buttonsStyling: !1,
							confirmButtonText: 'Ok, got it!',
							customClass: {
								confirmButton: 'btn fw-bold btn-primary',
							},
						})
					})
				}
			})
		}

		function editMenu (item){
			let url = item.getAttribute('href')
			location.href=url
		}

		$(".jstree_dragdrop")
			.on("redraw.jstree", function (e, data) {
				console.log(e.target.getAttribute("data-nav_position"))
				const targetId = e.target.id
				const menuName = e.target.getAttribute("data-nav_position")
				var v = $(`#${targetId}`).jstree(true).get_json('#', {flat:true})
				//- console.log(v)
				var redrawData = JSON.stringify(v);
				saveMenuSorting(redrawData,menuName)
			})
			.jstree();


block content
	.d-flex.flex-column.flex-column-fluid
		#kt_app_toolbar.app-toolbar.py-3.py-lg-6
			#kt_app_toolbar_container.app-container.container-xxl.d-flex.flex-stack
				.page-title.d-flex.flex-column.justify-content-center.flex-wrap.me-3
					h1.page-heading.d-flex.text-dark.fw-bold.fs-3.flex-column.justify-content-center.my-0
						| Menu Management
					ul.breadcrumb.breadcrumb-separatorless.fw-semibold.fs-7.my-0.pt-1
						li.breadcrumb-item.text-muted
							a.text-muted.text-hover-primary(href='/admin/dashboard') Home
						li.breadcrumb-item
							span.bullet.bg-gray-400.w-5px.h-2px
						li.breadcrumb-item.text-muted CMS
						li.breadcrumb-item
							span.bullet.bg-gray-400.w-5px.h-2px
						li.breadcrumb-item.text-muted Menu
				.d-flex.align-items-center.gap-2.gap-lg-3
					a.btn.btn-sm.fw-bold.btn-primary(href='#' data-bs-toggle='modal' data-bs-target='#kt_modal_create_app') Add New
		#kt_app_content.app-content.flex-column-fluid
			#kt_app_content_container.app-container.container
				.row.g-5
					each nav in menulist
						.col-lg-6
							.card.card-stretch.card-bordered.mb-5
								.card-header
									h3.card-title #{nav.nav_label}
								.card-body
									.jstree_dragdrop(id=`nav_${nav.nav_position}` data-nav_position=`${nav.nav_position}`)
										ul
											each menu,i in nav.nav_items
												li(data_id=`${menu._id}` url=JSON.stringify(menu.url) label= JSON.stringify(menu.label)) #{menu.label.en}
													.btn(id=`${menu._id}` nav_position=`${nav.nav_position}`  level='0' onClick='deleteMenuItem(this)')
														i.fa-solid.fa-trash.text-danger
													.btn(id=`${menu._id}` nav_position=`${nav.nav_position}`  level='0' href=`/admin/cms/menu/${nav.nav_position}/edit/${menu._id}/0` onClick='editMenu(this)')
														i.fa-solid.fa-pen.text-primary
													ul
														each first_level_child,j in menu.child
															li(data_id=`${first_level_child._id}` url=JSON.stringify(first_level_child.url) label= JSON.stringify(first_level_child.label)) #{first_level_child.label.en}
																.btn(id=`${first_level_child._id}` nav_position=`${nav.nav_position}`  level='1' onClick='deleteMenuItem(this)')
																	i.fa-solid.fa-trash.text-danger
																.btn(id=`${menu._id}` nav_position=`${nav.nav_position}`  level='0' href=`/admin/cms/menu/${nav.nav_position}/edit/${first_level_child._id}/1?parent_index=${i}` onClick='editMenu(this)')
																	i.fa-solid.fa-pen.text-primary
																ul
																	each second_level_child,k in first_level_child.child
																		li(data_id=`${second_level_child._id}` url=JSON.stringify(second_level_child.url) label= JSON.stringify(second_level_child.label)) #{second_level_child.label.en}
																			.btn(id=`${second_level_child._id}` nav_position=`${nav.nav_position}`  level='2' onClick='deleteMenuItem(this)')
																				i.fa-solid.fa-trash.text-danger
																			.btn(id=`${menu._id}` nav_position=`${nav.nav_position}`  level='0' href=`/admin/cms/menu/${nav.nav_position}/edit/${second_level_child._id}/2?parent_index=${i}&sec_parent_index=${j}` onClick='editMenu(this)')
																				i.fa-solid.fa-pen.text-primary
	#kt_modal_create_app.modal.fade(tabindex='-1' aria-hidden='true')
		// begin::Modal dialog
		.modal-dialog.modal-dialog-centered.mw-900px
			.modal-content
				.modal-header
					h2 Add Menu
					.btn.btn-sm.btn-icon.btn-active-color-primary(data-bs-dismiss='modal' )
						h3 X						
				.modal-body.py-lg-10.px-lg-10
					form#kt_modal_create_app_form.form.es-form(action=`/admin/cms/menu/add` data-kt-redirect-url=`/admin/cms/menu`  method='post')
						.card.card-flush
							.card-body.pt-0
								.col-md-6
									label.d-flex.align-items-center.fs-6.fw-semibold.mb-2
										span.required  Menu Position
										i.fas.fa-exclamation-circle.ms-2.fs-7(data-bs-toggle='tooltip' aria-label='path' data-kt-initialized='1')
									select#kt_ecommerce_add_product_status_select.form-select.mb-2(data-control='select2' name="menu_position" data-hide-search='true' data-placeholder='Select an option')
										each nav,i in menulist
											option(value=nav.nav_position selected=i==0) #{nav.nav_label}
									.fv-plugins-message-container.invalid-feedback(id=`field-error-menu_position`)
								ul.nav.nav-tabs.nav-line-tabs.mb-5.fs-6
									each brandLanguage, i in authAdmin.selected_brand.languages
										li.nav-item
											a.nav-link(class= (i== 0 ? 'active' : '') data-bs-toggle='tab' href=`#kt_tab_pane_${brandLanguage.prefix}`) #{brandLanguage.name}
								#myTabContent.tab-content.tab-content-fields
									each brandLanguage, i in authAdmin.selected_brand.languages
										.tab-pane.fade(class= (i== 0 ? 'active show' : '') role='tabpanel' id=`kt_tab_pane_${brandLanguage.prefix}`)
											.d-flex.flex-column.fv-row.fv-plugins-icon-container.col-md-6
												label.d-flex.align-items-center.fs-6.fw-semibold.mb-2
													span.required  Menu name (#{brandLanguage.prefix})
													i.fas.fa-exclamation-circle.ms-2.fs-7(data-bs-toggle='tooltip' aria-label='label' data-kt-initialized='1')
												input.form-control.mb-2(type='text' name=`label[${brandLanguage.prefix}]` placeholder='Menu label' value='')
												.fv-plugins-message-container.invalid-feedback(id=`field-error-label_${brandLanguage.prefix}`)
											.col-md-6
												label.d-flex.align-items-center.fs-6.fw-semibold.mb-2
													span.required  Path (#{brandLanguage.prefix})
													i.fas.fa-exclamation-circle.ms-2.fs-7(data-bs-toggle='tooltip' aria-label='path' data-kt-initialized='1')
												input.form-control.mb-2(type='text' name=`path[${brandLanguage.prefix}]` placeholder='Menu path url' value='')
												.fv-plugins-message-container.invalid-feedback(id=`field-error-path_${brandLanguage.prefix}`)
								.col-md-6
									label.d-flex.align-items-center.fs-6.fw-semibold.mb-2
										span  Link Type
										i.fas.fa-exclamation-circle.ms-2.fs-7(data-bs-toggle='tooltip' aria-label='path' data-kt-initialized='1')
									.form-check.form-check-custom.form-check-solid
										input#flexCheckChecked.form-check-input(type='checkbox' name="external" value='true' )
										label.form-check-label(for='flexCheckChecked') External 

									.card-toolbar.mt-8.d-flex.justify-content-end
										button.btn.btn-sm.btn-success.form-submit-btn(type='submit')
											span.label Save
											span.preloader.d-none Saving...


